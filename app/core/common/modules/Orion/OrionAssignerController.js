app.factory("OrionAssignerController",["$q","$rootScope","OrionUtilities","$timeout","$interval","$window","OrionCategoryUrlExtractor",function(e,r,t,n,o,c,s){var i,a,u={},l=[],f=-1,g=new OrionSpeed,h=new AtomicObject(g.db),y=new ActiveTask,v=new RejectedTask,d=new OrionActivity;return{on:function(){var r=this,c=e.defer();return h.$on().then(function(e){n(function(){a=e,t.buildExtractionObject().then(function(e){n(function(){u=e,console.log(e),r.buildCategoryUrls(),i=o(r.extractCategoryUrl,h.item.assigner.categoryUrlExtraction,l.length,!1,r),console.log("Orion Assigner Initialized"),d.log("assigner"),c.resolve(!0)},h.item.assigner.extractionObjectConstruction)}).catch(function(e){c.reject(e)}),document.addEventListener(a+"_object_changed",function(e){n(function(){h.item=e})},!1)},100)}).catch(function(e){c.reject(e)}),c.promise},extractCategoryUrl:function(r){var t=e.defer();if(++f,f<=l.length){var n={url:l[f].categoryUrl,source:{name:u.sources[l[f].sourceKey].information.name,parentSelector:u.sources[l[f].sourceKey].extraction.categoryUrls.parentSelector,childSelector:u.sources[l[f].sourceKey].extraction.categoryUrls.childSelector}};s.extractCategoryUrl(n).then(function(e){d.log("assigner"),r.processTasks(e,l[f].categoryUrl,l[f].sourceKey,l[f].categoryKey).then(function(){f==l.length-1&&r.reset(),t.resolve(!0)}).catch(function(e){console.log(e),f==l.length-1&&r.reset(),t.reject(e)})}).catch(function(e){f==l.length-1&&r.reset(),t.reject(e)})}else r.reset();return t.promise},processTasks:function(r,t,n,o){var c=this,s=e.defer();return c.filterUrls(r).then(function(e){for(var r=0;r<e.length;r++)c.createTask(e[r],t,n,o).then(function(){s.resolve(!0)}).catch(function(e){s.reject(e)});d.log("assigner"),s.resolve(!0)}).catch(function(e){s.reject(e)}),s.promise},createTask:function(r,t,n,o){var c=e.defer();return y.db.query.create({articleUrl:r,categoryUrl:t,sourceKey:n,categoryKey:o}).then(function(e){c.resolve(e)}).catch(function(e){c.reject(e)}),c.promise},filterUrls:function(r){var t=this,n=e.defer(),o=[],c=0;for(c;c<r.length;c++)t.filterUrl(r[c]).then(function(e){e.exists||o.push(e.url),n.resolve(o)}).catch(function(e){n.reject(e)});return d.log("assigner"),n.promise},filterUrl:function(r){var t=this,n=e.defer();return t.articleExists(r).then(function(e){e?n.resolve({exists:!0,url:r}):n.resolve({exists:!1,url:r}),d.log("assigner")}).catch(function(e){n.reject(e)}),n.promise},buildCategoryUrls:function(){for(var e in u.sources)if(u.sources.hasOwnProperty(e))for(var r in u.sources[e].categories)if(u.sources[e].categories.hasOwnProperty(r)){for(var t in u.sources[e].categories[r])u.sources[e].categories.hasOwnProperty(r)&&l.push({categoryUrl:u.sources[e].categories[r][t].url,categoryKey:r,sourceKey:e});d.log("assigner")}},articleExists:function(r){var t=e.defer();return y.urlExists(r).then(function(e){v.urlExists(r).then(function(r){t.resolve(e||r)}).catch(function(e){t.reject(e)})}).catch(function(e){t.reject(e)}),t.promise},reset:function(){var e=this;e.off(),n(function(){e.on()},1e3)},off:function(){o.cancel(i),i=null,u={},l=[],f=-1}}}]);