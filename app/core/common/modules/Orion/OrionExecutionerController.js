app.factory("OrionExecutionerController",["$q","$rootScope","$timeout","$interval","OrionArticleBuilder","OrionUtilities",function(e,t,n,c,r,o){var i,a,u={},l=new OrionSpeed,f=new AtomicObject(l.db),s=new ActiveTask,d=new RejectedTask,h=new CompletedTask,v=new OrionActivity,m=new Article,b=new PendingArticle,j=new Source,g=new Category,y={};return{on:function(){var t=this,r=e.defer();return f.$on().then(function(e){n(function(){a=e,o.buildExtractionObject().then(function(e){n(function(){u=e,i=c(t.extractArticleUrl,f.item.executioner.articleUrlExtraction,0,!1,t),console.log("Orion Executioner Initialized"),v.log("executioner"),r.resolve(!0)},f.item.executioner.extractionObjectConstruction)}).catch(function(e){r.reject(e)}),document.addEventListener(a+"_object_changed",function(e){n(function(){f.item=e})},!1)},100)}).catch(function(e){r.reject(e)}),r.promise},extractArticleUrl:function(t){var n=e.defer();return t.assignTask().then(function(){y&&y.articleUrl&&y.sourceKey&&y.categoryKey?r.build({url:y.articleUrl,source:{name:u.sources[y.sourceKey].information.name,extraction:u.sources[y.sourceKey].extraction}}).then(function(e){if(v.log("executioner"),e){var c=u.sources[y.sourceKey].information,r=u.categories[y.categoryKey];t.handleArticle({url:e.url,title:e.title,description:e.description,image:e.image,content:e.content,source:j.db.schema.build(c,"foreign"),category:g.db.schema.build(r,"foreign"),creationTS:y.creationTS},r.autoSave).then(function(){n.resolve(!0)}).catch(function(e){n.reject(e)})}else t.handleInvalidArticle().then(function(){n.resolve(!0)}).catch(function(e){n.reject(e)})}).catch(function(e){n.reject(e)}):n.resolve(!0)}).catch(function(e){n.reject(e)}),n.promise},handleArticle:function(t,n){var c=this,r=e.defer();return n?m.db.query.create(t).then(function(){c.handleArticleSaved().then(function(){r.resolve(!0)}).catch(function(e){r.reject(e)})}).catch(function(e){console.log(e),r.reject(e)}):b.db.query.create(t).then(function(){c.handleArticleSaved().then(function(){r.resolve(!0)}).catch(function(e){r.reject(e)})}).catch(function(e){console.log(e),r.reject(e)}),r.promise},handleArticleSaved:function(){var t=e.defer();return h.db.query.create(y).then(function(){y={},t.resolve(!0)}).catch(function(e){t.reject(e)}),t.promise},handleInvalidArticle:function(){var t=e.defer(),n=y;return n.reason="INVALID_ARTICLE",d.db.query.create(n).then(function(){y={},t.resolve(!0)}).catch(function(e){t.reject(e)}),t.promise},assignTask:function(){var t=e.defer(),n=s.db.ref.root.child(s.db.ref.primary).limitToLast(1);return n.once("value").then(function(e){e.exists()?e.forEach(function(e){y=s.db.schema.build(e,"snapshot"),s.db.query.remove(y).then(function(){t.resolve(!0)}).catch(function(e){t.reject(e)})}):t.resolve(!1)}).catch(function(e){t.reject(e)}),t.promise},off:function(){c.cancel(i),i=null,u={},y={}}}}]);