app.factory("SourceAtomicUpdates",["$q","PostObjectService","SourceObjectService",function(e,t,s){return{updateSource:function(t){var s=e.defer();return this.getPostsArray(t).then(angular.bind(this,function(e){this.getUserPostRefs(t).then(angular.bind(this,function(o){this.getSourceAssignmentRefs(t).then(angular.bind(this,function(r){var n={mainPostRefs:this.getMainPostRefs(e),sourcePostRefs:this.getSourcePostRefs(e),categoryPostRefs:this.getCategoryPostRefs(e),hashtagPostRefs:this.getHashtagPostRefs(e),leaderPostRefs:this.getLeaderPostRefs(e),outstandingPostRefs:this.getOutstandingPostRefs(e),userPostRefs:o,sourceAssignmentRefs:r},a=this.buildFanoutObject(t,n,"edit");rootRef.update(a).then(function(){s.resolve(!0)}).catch(function(e){s.reject(e)})})).catch(function(e){s.reject(e)})})).catch(function(e){s.reject(e)})})).catch(function(e){s.reject(e)}),s.promise},deleteSource:function(t){var s=e.defer();return this.getPostsArray(t).then(angular.bind(this,function(e){this.getUserPostRefsDel(t).then(angular.bind(this,function(o){this.getSourceAssignmentRefs(t).then(angular.bind(this,function(r){var n={mainPostRefs:this.getMainPostRefsDel(e),sourcePostRefs:this.getSourcePostRefsDel(e),categoryPostRefs:this.getCategoryPostRefsDel(e),hashtagPostRefs:this.getHashtagPostRefsDel(e),leaderPostRefs:this.getLeaderPostRefsDel(e),outstandingPostRefs:this.getOutstandingPostRefsDel(e),userPostRefs:o,sourceAssignmentRefs:r},a=this.buildFanoutObject(t,n,"delete");rootRef.update(a).then(function(){s.resolve(!0)}).catch(function(e){s.reject(e)})})).catch(function(e){s.reject(e)})})).catch(function(e){s.reject(e)})})).catch(function(e){s.reject(e)}),s.promise},buildFanoutObject:function(e,t,o){var r={},n={};"edit"==o&&(n=s.buildMinifiedAlt(e));for(var a=t.mainPostRefs,i=0;i<a.length;i++)r[a[i]]=n;for(var u=t.sourcePostRefs,i=0;i<u.length;i++)r[u[i]]=n;for(var c=t.categoryPostRefs,i=0;i<c.length;i++)r[c[i]]=n;for(var f=t.hashtagPostRefs,i=0;i<f.length;i++)r[f[i]]=n;for(var h=t.leaderPostRefs,i=0;i<h.length;i++)r[h[i]]=n;for(var g=t.outstandingPostRefs,i=0;i<g.length;i++)r[g[i]]=n;for(var d=t.userPostRefs,i=0;i<d.length;i++)r[d[i]]=n;for(var l=t.sourceAssignmentRefs,i=0;i<l.length;i++)r[l[i]]=n;return r},getPostsArray:function(s){var o=e.defer(),r=rootRef.child("sourcePosts/"+s.$id),n=[];return r.once("value").then(function(e){e.forEach(function(e){e.forEach(function(e){n.push(t.buildFromSnapshot(e))})}),o.resolve(n)}),o.promise},getMainPostRefs:function(e){for(var t=[],s=0;s<e.length;s++)t.push("/posts/"+e[s].$id+"/source");return t},getMainPostRefsDel:function(e){for(var t=[],s=0;s<e.length;s++)t.push("/posts/"+e[s].$id);return t},getSourcePostRefs:function(e){for(var t=[],s=0;s<e.length;s++)t.push("/sourcePosts/"+e[s].source.id+"/"+e[s].category.id+"/"+e[s].$id+"/source");return t},getSourcePostRefsDel:function(e){for(var t=[],s=0;s<e.length;s++)t.push("/sourcePosts/"+e[s].source.id+"/"+e[s].category.id+"/"+e[s].$id);return t},getCategoryPostRefs:function(e){for(var t=[],s=0;s<e.length;s++)t.push("/categoryPosts/"+e[s].category.id+"/"+e[s].$id+"/source");return t},getCategoryPostRefsDel:function(e){for(var t=[],s=0;s<e.length;s++)t.push("/categoryPosts/"+e[s].category.id+"/"+e[s].$id);return t},getHashtagPostRefs:function(e){for(var t=[],s=0;s<e.length;s++)e[s].primaryHashtag&&t.push("/hashtagPosts/"+e[s].primaryHashtag.id+"/"+e[s].$id+"/source"),void 0!=e[s].secondaryHashtags&&angular.forEach(e[s].secondaryHashtags,function(o,r){t.push("/hashtagPosts/"+r+"/"+e[s].$id+"/source")});return t},getHashtagPostRefsDel:function(e){for(var t=[],s=0;s<e.length;s++)e[s].primaryHashtag&&t.push("/hashtagPosts/"+e[s].primaryHashtag.id+"/"+e[s].$id),void 0!=e[s].secondaryHashtags&&angular.forEach(e[s].secondaryHashtags,function(o,r){t.push("/hashtagPosts/"+r+"/"+e[s].$id)});return t},getLeaderPostRefs:function(e){for(var t=[],s=0;s<e.length;s++)void 0!=e[s].leaders&&angular.forEach(e[s].leaders,function(o){t.push("/leaderPosts/"+o.id+"/"+e[s].$id+"/source")});return t},getLeaderPostRefsDel:function(e){for(var t=[],s=0;s<e.length;s++)void 0!=e[s].leaders&&angular.forEach(e[s].leaders,function(o){t.push("/leaderPosts/"+o.id+"/"+e[s].$id)});return t},getOutstandingPostRefs:function(e){for(var t=[],s=0;s<e.length;s++)e[s].outstanding&&t.push("/outstandingPosts/"+e[s].$id+"/source");return t},getOutstandingPostRefsDel:function(e){for(var t=[],s=0;s<e.length;s++)e[s].outstanding&&t.push("/outstandingPosts/"+e[s].$id);return t},getUserPostRefs:function(t){var s=e.defer(),o=rootRef.child("userPosts"),r=[];return o.once("value").then(function(e){e.forEach(function(e){e.forEach(function(s){s.val().source.id==t.$id&&r.push("/userPosts/"+e.key+"/"+s.key+"/source")})}),s.resolve(r)}),s.promise},getUserPostRefsDel:function(t){var s=e.defer(),o=rootRef.child("userPosts"),r=[];return o.once("value").then(function(e){e.forEach(function(e){e.forEach(function(s){s.val().source.id==t.$id&&r.push("/userPosts/"+e.key+"/"+s.key)})}),s.resolve(r)}),s.promise},getSourceAssignmentRefs:function(t){var s=e.defer(),o=[],r=rootRef.child("users").orderByChild("isAdmin").equalTo(!0);return r.once("value").then(function(e){e.forEach(function(e){e.val().sourcesAssignments&&t.$id in e.val().sourcesAssignments&&o.push("users/"+e.key+"/sourcesAssignments/"+t.$id)}),s.resolve(o)}),s.promise}}}]);