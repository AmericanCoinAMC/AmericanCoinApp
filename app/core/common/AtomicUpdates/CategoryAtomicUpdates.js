app.factory("CategoryAtomicUpdates",["$q","PostObjectService","CategoryObjectService",function(t,e,s){return{updateCategory:function(e){var s=t.defer();return this.getPostsArray(e).then(angular.bind(this,function(t){this.getUserPostRefs(e).then(angular.bind(this,function(o){this.getSourceCategoryRefs(e).then(angular.bind(this,function(r){var n={mainPostRefs:this.getMainPostRefs(t),sourcePostRefs:this.getSourcePostRefs(t),categoryPostRefs:this.getCategoryPostRefs(t),hashtagPostRefs:this.getHashtagPostRefs(t),leaderPostRefs:this.getLeaderPostRefs(t),outstandingPostRefs:this.getOutstandingPostRefs(t),sourceCategoryRefs:r,userPostRefs:o},a=this.buildFanoutObject(e,n,"edit");rootRef.update(a).then(function(){s.resolve(!0)}).catch(function(t){s.reject(t)})})).catch(function(t){s.reject(t)})})).catch(function(t){s.reject(t)})})).catch(function(t){s.reject(t)}),s.promise},deleteCategory:function(e){var s=t.defer();return this.getPostsArray(e).then(angular.bind(this,function(t){this.getUserPostRefsDel(e).then(angular.bind(this,function(o){this.getSourceCategoryRefsDel(e).then(angular.bind(this,function(r){var n={mainPostRefs:this.getMainPostRefsDel(t),sourcePostRefs:this.getSourcePostRefsDel(t),categoryPostRefs:this.getCategoryPostRefsDel(t),hashtagPostRefs:this.getHashtagPostRefsDel(t),leaderPostRefs:this.getLeaderPostRefsDel(t),outstandingPostRefs:this.getOutstandingPostRefsDel(t),sourceCategoryRefs:r,userPostRefs:o},a=this.buildFanoutObject(e,n,"delete");rootRef.update(a).then(function(){s.resolve(!0)}).catch(function(t){s.reject(t)})})).catch(function(t){s.reject(t)})})).catch(function(t){s.reject(t)})})).catch(function(t){s.reject(t)}),s.promise},buildFanoutObject:function(t,e,o){var r={},n={};"edit"==o&&(n=s.buildMinifiedAlt(t));for(var a=e.mainPostRefs,i=0;i<a.length;i++)r[a[i]]=n;for(var u=e.sourcePostRefs,i=0;i<u.length;i++)r[u[i]]=n;for(var f=e.categoryPostRefs,i=0;i<f.length;i++)r[f[i]]=n;for(var c=e.hashtagPostRefs,i=0;i<c.length;i++)r[c[i]]=n;for(var g=e.leaderPostRefs,i=0;i<g.length;i++)r[g[i]]=n;for(var h=e.outstandingPostRefs,i=0;i<h.length;i++)r[h[i]]=n;for(var d=e.sourceCategoryRefs,i=0;i<d.length;i++)r[d[i]]=n;for(var l=e.userPostRefs,i=0;i<l.length;i++)r[l[i]]=n;return r},getPostsArray:function(s){var o=t.defer(),r=rootRef.child("categoryPosts/"+s.$id),n=[];return r.once("value").then(function(t){t.forEach(function(t){n.push(e.buildFromSnapshot(t))}),o.resolve(n)}),o.promise},getMainPostRefs:function(t){for(var e=[],s=0;s<t.length;s++)e.push("/posts/"+t[s].$id+"/category");return e},getMainPostRefsDel:function(t){for(var e=[],s=0;s<t.length;s++)e.push("/posts/"+t[s].$id);return e},getSourcePostRefs:function(t){for(var e=[],s=0;s<t.length;s++)e.push("/sourcePosts/"+t[s].source.id+"/"+t[s].category.id+"/"+t[s].$id+"/category");return e},getSourcePostRefsDel:function(t){for(var e=[],s=0;s<t.length;s++)e.push("/sourcePosts/"+t[s].source.id+"/"+t[s].category.id+"/"+t[s].$id);return e},getCategoryPostRefs:function(t){for(var e=[],s=0;s<t.length;s++)e.push("/categoryPosts/"+t[s].category.id+"/"+t[s].$id+"/category");return e},getCategoryPostRefsDel:function(t){for(var e=[],s=0;s<t.length;s++)e.push("/categoryPosts/"+t[s].category.id+"/"+t[s].$id);return e},getHashtagPostRefs:function(t){for(var e=[],s=0;s<t.length;s++)t[s].primaryHashtag&&e.push("/hashtagPosts/"+t[s].primaryHashtag.id+"/"+t[s].$id+"/category"),void 0!=t[s].secondaryHashtags&&angular.forEach(t[s].secondaryHashtags,function(o,r){e.push("/hashtagPosts/"+r+"/"+t[s].$id+"/category")});return e},getHashtagPostRefsDel:function(t){for(var e=[],s=0;s<t.length;s++)t[s].hashtag&&(t[s].primaryHashtag&&e.push("/hashtagPosts/"+t[s].primaryHashtag.id+"/"+t[s].$id),void 0!=t[s].secondaryHashtags&&angular.forEach(t[s].secondaryHashtags,function(o,r){e.push("/hashtagPosts/"+r+"/"+t[s].$id)}));return e},getLeaderPostRefs:function(t){for(var e=[],s=0;s<t.length;s++)void 0!=t[s].leaders&&angular.forEach(t[s].leaders,function(o){e.push("/leaderPosts/"+o.id+"/"+t[s].$id+"/category")});return e},getLeaderPostRefsDel:function(t){for(var e=[],s=0;s<t.length;s++)void 0!=t[s].leaders&&angular.forEach(t[s].leaders,function(o){e.push("/leaderPosts/"+o.id+"/"+t[s].$id)});return e},getOutstandingPostRefs:function(t){for(var e=[],s=0;s<t.length;s++)t[s].outstanding&&e.push("/outstandingPosts/"+t[s].$id+"/category");return e},getOutstandingPostRefsDel:function(t){for(var e=[],s=0;s<t.length;s++)t[s].outstanding&&e.push("/outstandingPosts/"+t[s].$id);return e},getUserPostRefs:function(e){var s=t.defer(),o=rootRef.child("userPosts"),r=[];return o.once("value").then(function(t){t.forEach(function(t){t.forEach(function(s){s.val().category.id==e.$id&&r.push("/userPosts/"+t.key+"/"+s.key+"/category")})}),s.resolve(r)}),s.promise},getUserPostRefsDel:function(e){var s=t.defer(),o=rootRef.child("userPosts"),r=[];return o.once("value").then(function(t){t.forEach(function(t){t.forEach(function(s){s.val().category.id==e.$id&&r.push("/userPosts/"+t.key+"/"+s.key)})}),s.resolve(r)}),s.promise},getSourceCategoryRefs:function(e){var s=t.defer(),o=[],r=rootRef.child("sourcesCategories");return r.once("value").then(function(t){t.forEach(function(t){t.val()&&e.$id in t.val()&&o.push("sourcesCategories/"+t.key+"/"+e.$id+"/details")}),s.resolve(o)}),s.promise},getSourceCategoryRefsDel:function(e){var s=t.defer(),o=[],r=rootRef.child("sourcesCategories");return r.once("value").then(function(t){t.forEach(function(t){t.val()&&e.$id in t.val()&&o.push("sourcesCategories/"+t.key+"/"+e.$id)}),s.resolve(o)}),s.promise}}}]);