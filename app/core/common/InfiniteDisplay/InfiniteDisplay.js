app.factory("InfiniteDisplay",["$timeout","$q","$rootScope","Server",function(t,i,e,s){var n=function(t){this.id=0,this.ref=t.ref,this.objectBuilder=t.objectBuilder,this.firstLotSize=t.firstLotSize,this.nextLotSize=t.nextLotSize,this.eventListenerRef=null,this.displayedItems=0,this.subscribed=!1,this.firstLotLoaded=!1,this.itemsRemaining=!0,this.fetching=!1,this.items=[]};return n.prototype.initialize=function(){var t=i.defer();return this.loadFirstLot().then(angular.bind(this,function(){s.updateTimestamp().then(angular.bind(this,function(){s.getTimestamp().then(angular.bind(this,function(i){this.eventListenerRef=this.ref.orderByChild("timestamp").startAt(i),this.id=i,this.firstLotLoaded=!0,this.subscribe(),t.resolve(this.id)})).catch(function(i){t.reject(i)})})).catch(function(i){t.reject(i)})})).catch(function(i){t.reject(i)}),t.promise},n.prototype.loadFirstLot=function(){var t=i.defer(),e=this.ref.limitToFirst(this.firstLotSize);return e.once("value").then(angular.bind(this,function(i){i.forEach(angular.bind(this,function(t){this.addItem(t,!1)})),t.resolve(!0)})).catch(function(i){t.reject(i)}),t.promise},n.prototype.loadNextLot=function(){var e=i.defer();if(this.fetching||void 0==this.items[parseInt(this.displayedItems-1)])t(function(){e.resolve(!1)},2e3);else{this.fetching=!0;var s=this.items.length,n=this.ref.startAt(this.items[parseInt(this.displayedItems-1)].$priority+1).limitToFirst(this.nextLotSize);n.once("value").then(angular.bind(this,function(i){i.forEach(angular.bind(this,function(t){this.addItem(t,!1)})),s==this.items.length&&(this.itemsRemaining=!1),t(angular.bind(this,function(){this.fetching=!1,e.resolve(!0)}),4e3)})).catch(function(t){e.reject(t)})}return e.promise},n.prototype.subscribe=function(){this.subscribed=!0,this.eventListenerRef.on("child_added",angular.bind(this,function(t){console.log("child_added"),this.addItem(t,!0)})),this.eventListenerRef.on("child_changed",angular.bind(this,function(t){console.log("child_changed"),this.editItem(t,!0)})),this.eventListenerRef.on("child_moved",angular.bind(this,function(t){console.log("child_moved"),this.editItem(t,!0)})),this.eventListenerRef.on("child_removed",angular.bind(this,function(t){console.log("child_removed"),this.removeItem(t)})),console.log("Infinite Display Instance: "+this.id+" subscribed.")},n.prototype.getId=function(){return this.id},n.prototype.getItems=function(){return this.items},n.prototype.getDisplayedItems=function(){return this.displayedItems},n.prototype.isFetching=function(){return this.fetching},n.prototype.isFirstLotLoaded=function(){return this.firstLotLoaded},n.prototype.getItemsRemaining=function(){return this.itemsRemaining},n.prototype.addItem=function(t,i){if(!this.itemExists(t)){var e=this.objectBuilder.buildFromSnapshot(t);i&&(e.newItem=!0),this.items.push(e),this.displayedItems+=1}},n.prototype.editItem=function(t){for(var i=this.objectBuilder.buildFromSnapshot(t),e=0;e<this.items.length;e++)this.items[e].$id==i.$id&&(this.items[e]=i)},n.prototype.removeItem=function(t){for(var i=0;i<this.items.length;i++)this.items[i].$id==t.key&&(this.items.splice(i,1),this.displayedItems-=1)},n.prototype.itemExists=function(t){for(var i=!1,e=0;e<this.items.length;e++)this.items[e].$id==t.key&&(i=!0);return i},n.prototype.deactivate=function(){this.unsubscribe(),this.resetDefaults()},n.prototype.unsubscribe=function(){this.subscribed&&(this.eventListenerRef.off("child_added"),this.eventListenerRef.off("child_changed"),this.eventListenerRef.off("child_moved"),this.eventListenerRef.off("child_removed"),this.subscribed=!1,console.log("Infinite Display Instance: "+this.id+" unsubscribed."))},n.prototype.resetDefaults=function(){this.id=0,this.ref=null,this.eventListenerRef=null,this.objectBuilder=null,this.firstLotSize=null,this.nextLotSize=null,this.displayedItems=0,this.subscribed=!1,this.firstLotLoaded=!1,this.itemsRemaining=!0,this.fetching=!1,this.items=[]},n}]);