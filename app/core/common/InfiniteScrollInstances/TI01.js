app.factory("TI01",["$timeout","$q","$rootScope","Server",function(t,n,i,e){var o,r,s,a,c,u=0,d=!1,l=!1,h=!0,f=!1,g=[];return{initialize:function(t){var i=n.defer();return this.deactivate(),o=t.firstLotSize,r=t.nextLotSize,s=t.ref,c=t.objectBuilder,e.updateTimestamp().then(angular.bind(this,function(){this.loadFirstLot().then(angular.bind(this,function(){l=!0,i.resolve(!0)})).catch(function(t){i.reject(t)})})).catch(function(t){i.reject(t)}),i.promise},loadFirstLot:function(){var t=n.defer(),i=s.limitToFirst(o);return i.once("value").then(angular.bind(this,function(n){n.forEach(angular.bind(this,function(t){this.addItem(t)})),e.getTimestamp().then(angular.bind(this,function(n){a=s.orderByChild("timestamp").startAt(n),this.subscribe(),l=!0,t.resolve(!0)})).catch(function(n){t.reject(n)})})).catch(function(n){t.reject(n)}),t.promise},loadNextLot:function(){var t=n.defer();if(f||void 0==g[parseInt(u-1)])t.resolve(!1);else{f=!0;var i=g.length,e=s.startAt(g[parseInt(u-1)].$priority+1).limitToFirst(r);e.once("value").then(angular.bind(this,function(n){n.forEach(angular.bind(this,function(t){this.addItem(t)})),i==g.length&&(h=!1),f=!1,t.resolve(!0)})).catch(function(n){t.reject(n)})}return t.promise},subscribe:function(){d=!0,a.on("child_added",angular.bind(this,function(n){l&&(console.log("child_added"),this.addItem(n),t(angular.bind(this,function(){this.sortArray()})))})),a.on("child_changed",angular.bind(this,function(n){l&&(console.log("child_changed"),this.editItem(n),t(angular.bind(this,function(){this.sortArray()})))})),a.on("child_moved",angular.bind(this,function(n){l&&(console.log("child_moved"),this.editItem(n),t(angular.bind(this,function(){this.sortArray()})))})),a.on("child_removed",angular.bind(this,function(n){l&&(console.log("child_removed"),this.removeItem(n),t(angular.bind(this,function(){this.sortArray()})))})),i.$on("temporaryInstanceAssigned",angular.bind(this,function(){this.deactivate()})),console.log("Event Listeners On")},deactivate:function(){this.unsubscribe(),this.resetDefaults()},unsubscribe:function(){d&&(a.off("child_added"),a.off("child_changed"),a.off("child_moved"),a.off("child_removed"),console.log("Event Listeners Off"),d=!1)},resetDefaults:function(){o=0,r=0,u=0,l=!1,h=!0,f=!1,g=[],s={},c={}},getItems:function(){return g},getDisplayedTotal:function(){return u},isFetching:function(){return f},isFirstLotLoaded:function(){return l},itemsRemaining:function(){return h},isAvailable:function(){return!g.length||!d},addItem:function(t){this.itemExists(t)||(g.push(c.buildFromSnapshot(t)),u+=1)},editItem:function(t){for(var n=c.buildFromSnapshot(t),i=0;i<g.length;i++)g[i].$id==n.$id&&(g[i]=n)},removeItem:function(t){for(var n=0;n<g.length;n++)g[n].$id==t.key&&(g.splice(n,1),u-=1)},itemExists:function(t){for(var n=!1,i=0;i<g.length;i++)g[i].$id==t.key&&(n=!0);return n},sortArray:function(){g.sort(function(t,n){return parseFloat(t.$priority)-parseFloat(n.$priority)})}}}]);